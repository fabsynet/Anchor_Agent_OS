---
phase: 03-tasks-renewals-and-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - packages/shared/src/types/task.ts
  - packages/shared/src/types/activity.ts
  - packages/shared/src/validation/task.schema.ts
  - packages/shared/src/constants/tasks.ts
  - packages/shared/src/index.ts
  - apps/api/tsconfig.json
  - apps/api/package.json
  - apps/web/package.json
autonomous: true

must_haves:
  truths:
    - "Task model exists in Prisma schema with all required fields and relations"
    - "Shared types and Zod schemas are importable from @anchor/shared"
    - "New dependencies (@nestjs/schedule, @dnd-kit/*) are installed"
    - "API tsconfig supports JSX compilation for React Email templates"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "Task model, TaskStatus/TaskPriority/TaskType enums, updated ActivityEventType enum, digestOptOut on User"
      contains: "model Task"
    - path: "packages/shared/src/types/task.ts"
      provides: "Task, TaskWithRelations, TaskStatus, TaskPriority, TaskType types"
      exports: ["Task", "TaskWithRelations", "TaskStatus", "TaskPriority", "TaskType"]
    - path: "packages/shared/src/validation/task.schema.ts"
      provides: "createTaskSchema, updateTaskSchema, searchTasksSchema"
      exports: ["createTaskSchema", "updateTaskSchema"]
    - path: "packages/shared/src/constants/tasks.ts"
      provides: "TASK_STATUSES, TASK_PRIORITIES, RENEWAL_MILESTONES constants"
      exports: ["TASK_STATUSES", "TASK_PRIORITIES"]
    - path: "packages/shared/src/index.ts"
      provides: "Re-exports all new task types, schemas, and constants"
  key_links:
    - from: "packages/shared/src/index.ts"
      to: "packages/shared/src/types/task.ts"
      via: "re-export"
      pattern: "export.*from.*types/task"
    - from: "packages/database/prisma/schema.prisma"
      to: "packages/shared/src/types/task.ts"
      via: "type mirrors schema"
      pattern: "TaskStatus|TaskPriority|TaskType"
---

<objective>
Create the data foundation for Phase 3: Task model in Prisma, shared TypeScript types and Zod validation schemas, task-related constants, install new dependencies, and configure API tsconfig for JSX support (needed for React Email templates in Plan 03).

Purpose: All subsequent plans (task backend, renewal engine, dashboard, frontend, notifications) depend on these shared types, schemas, and the Prisma model.
Output: Updated Prisma schema with Task model and new enums, shared types/validation/constants for tasks, installed deps.
</objective>

<execution_context>
@C:\Users\abuba\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abuba\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-CONTEXT.md
@.planning/phases/03-tasks-renewals-and-dashboard/03-RESEARCH.md
@packages/database/prisma/schema.prisma
@packages/shared/src/index.ts
@packages/shared/src/types/policy.ts
@packages/shared/src/types/activity.ts
@apps/api/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema -- Task model, enums, and User digestOptOut</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
Add the following to the Prisma schema:

1. **New enums** (add after existing enums, before models):
```prisma
enum TaskStatus {
  todo
  in_progress
  waiting
  done
  @@map("task_status")
}

enum TaskPriority {
  low
  medium
  high
  urgent
  @@map("task_priority")
}

enum TaskType {
  manual
  renewal
  @@map("task_type")
}
```

2. **Update ActivityEventType enum** -- add three new values:
```
task_created
task_completed
task_status_changed
```

3. **Add `digestOptOut` to User model** (per user decision: opt-out toggle for daily digest):
```prisma
digestOptOut  Boolean  @default(false) @map("digest_opt_out")
```

4. **Create Task model** (add after Note model):
```prisma
model Task {
  id                String       @id @default(uuid()) @db.Uuid
  tenantId          String       @map("tenant_id") @db.Uuid
  title             String
  description       String?
  status            TaskStatus   @default(todo)
  priority          TaskPriority @default(medium)
  type              TaskType     @default(manual)
  dueDate           DateTime?    @map("due_date") @db.Date
  assigneeId        String?      @map("assignee_id") @db.Uuid
  clientId          String?      @map("client_id") @db.Uuid
  policyId          String?      @map("policy_id") @db.Uuid
  createdById       String       @map("created_by_id") @db.Uuid
  renewalDaysBefore Int?         @map("renewal_days_before")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  tenant    Tenant  @relation(fields: [tenantId], references: [id])
  assignee  User?   @relation("taskAssignee", fields: [assigneeId], references: [id])
  client    Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policy    Policy? @relation(fields: [policyId], references: [id], onDelete: Cascade)
  createdBy User    @relation("taskCreatedBy", fields: [createdById], references: [id])

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, dueDate])
  @@index([policyId, type, status])
  @@map("tasks")
}
```

5. **Add reverse relations to existing models**:
- `Tenant`: add `tasks Task[]`
- `User`: add `tasksAssigned Task[] @relation("taskAssignee")` and `tasksCreated Task[] @relation("taskCreatedBy")`
- `Client`: add `tasks Task[]`
- `Policy`: add `tasks Task[]`

CRITICAL: `onDelete: Cascade` on `policyId` ensures policy deletion auto-deletes renewal tasks (no orphans).
CRITICAL: The tenant extension uses `$allModels` so Task will automatically inherit tenant scoping for findMany/findFirst/create/update/delete.

After editing schema, run:
```bash
pnpm --filter database exec prisma db push
pnpm --filter database exec prisma generate
```
  </action>
  <verify>
Run `pnpm --filter database exec prisma validate` -- should exit 0 with no errors.
Run `pnpm --filter database exec prisma generate` -- should generate client successfully.
Verify Task model fields by checking generated Prisma client types.
  </verify>
  <done>Prisma schema has Task model with all fields, enums, relations, and indexes. User model has digestOptOut. ActivityEventType has task_created, task_completed, task_status_changed. Schema validates and client generates cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Shared types, validation schemas, constants, and dependency installation</name>
  <files>
    packages/shared/src/types/task.ts
    packages/shared/src/types/activity.ts
    packages/shared/src/validation/task.schema.ts
    packages/shared/src/constants/tasks.ts
    packages/shared/src/index.ts
    apps/api/tsconfig.json
    apps/api/package.json
    apps/web/package.json
  </files>
  <action>
**Step 1: Install dependencies**

```bash
# API: cron scheduling + @react-email/render for HTML generation
pnpm --filter api add @nestjs/schedule @react-email/render

# Web: kanban drag-and-drop
pnpm --filter web add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**Step 2: Create `packages/shared/src/types/task.ts`**

```typescript
export type TaskStatus = 'todo' | 'in_progress' | 'waiting' | 'done';
export type TaskPriority = 'low' | 'medium' | 'high' | 'urgent';
export type TaskType = 'manual' | 'renewal';

export interface Task {
  id: string;
  tenantId: string;
  title: string;
  description: string | null;
  status: TaskStatus;
  priority: TaskPriority;
  type: TaskType;
  dueDate: string | null;
  assigneeId: string | null;
  clientId: string | null;
  policyId: string | null;
  createdById: string;
  renewalDaysBefore: number | null;
  createdAt: string;
  updatedAt: string;
}

export interface TaskWithRelations extends Task {
  assignee?: { id: string; firstName: string; lastName: string } | null;
  client?: { id: string; firstName: string; lastName: string } | null;
  policy?: { id: string; type: string; carrier: string | null; policyNumber: string | null } | null;
}
```

**Step 3: Update `packages/shared/src/types/activity.ts`**

Add `task_created`, `task_completed`, and `task_status_changed` to the `ActivityEventType` union type (matches the Prisma enum update).

**Step 4: Create `packages/shared/src/validation/task.schema.ts`**

```typescript
import { z } from 'zod';

export const createTaskSchema = z.object({
  title: z.string().min(1, 'Title is required').max(200),
  description: z.string().optional().or(z.literal('')),
  status: z.enum(['todo', 'in_progress', 'waiting', 'done']).default('todo'),
  priority: z.enum(['low', 'medium', 'high', 'urgent']).default('medium'),
  dueDate: z.string().optional().or(z.literal('')),
  assigneeId: z.string().uuid().optional().or(z.literal('')),
  clientId: z.string().uuid().optional().or(z.literal('')),
  policyId: z.string().uuid().optional().or(z.literal('')),
});

export const updateTaskSchema = z.object({
  title: z.string().min(1).max(200).optional(),
  description: z.string().optional().or(z.literal('')),
  status: z.enum(['todo', 'in_progress', 'waiting', 'done']).optional(),
  priority: z.enum(['low', 'medium', 'high', 'urgent']).optional(),
  dueDate: z.string().optional().or(z.literal('')),
  assigneeId: z.string().uuid().optional().or(z.literal('')),
  clientId: z.string().uuid().optional().or(z.literal('')),
  policyId: z.string().uuid().optional().or(z.literal('')),
});

export type CreateTaskInput = z.input<typeof createTaskSchema>;
export type UpdateTaskInput = z.input<typeof updateTaskSchema>;
```

Note: Use `z.input<typeof schema>` (not `z.infer`) per Phase 2 decision -- `z.input` gives the input type where `.default()` fields are optional, which is what zodResolver needs.

**Step 5: Create `packages/shared/src/constants/tasks.ts`**

```typescript
export const TASK_STATUSES = [
  { value: 'todo', label: 'To Do' },
  { value: 'in_progress', label: 'In Progress' },
  { value: 'waiting', label: 'Waiting' },
  { value: 'done', label: 'Done' },
] as const;

export const TASK_PRIORITIES = [
  { value: 'low', label: 'Low' },
  { value: 'medium', label: 'Medium' },
  { value: 'high', label: 'High' },
  { value: 'urgent', label: 'Urgent' },
] as const;

export const RENEWAL_MILESTONES = [
  { daysBefore: 60, priority: 'medium' as const, label: '60-day reminder' },
  { daysBefore: 30, priority: 'high' as const, label: '30-day reminder' },
  { daysBefore: 7, priority: 'urgent' as const, label: '7-day reminder' },
] as const;
```

**Step 6: Update `packages/shared/src/index.ts`**

Add exports for task types, schemas, and constants:
```typescript
// Types - Tasks
export type { TaskStatus, TaskPriority, TaskType, Task, TaskWithRelations } from './types/task';

// Constants - Tasks
export { TASK_STATUSES, TASK_PRIORITIES, RENEWAL_MILESTONES } from './constants/tasks';

// Validation schemas - Tasks
export { createTaskSchema, updateTaskSchema } from './validation/task.schema';
export type { CreateTaskInput, UpdateTaskInput } from './validation/task.schema';
```

Also update the ActivityEventType re-export if needed (it should already re-export from './types/activity').

**Step 7: Update `apps/api/tsconfig.json`**

Add `"jsx": "react-jsx"` to compilerOptions (needed for React Email `.tsx` templates in the notifications module). This is the simplest approach per research.

  </action>
  <verify>
Run `pnpm --filter shared build` (or tsc check) -- shared package should compile cleanly.
Run `pnpm --filter api exec tsc --noEmit` -- API should compile (with JSX support).
Verify `@nestjs/schedule` is in `apps/api/package.json` dependencies.
Verify `@dnd-kit/core` is in `apps/web/package.json` dependencies.
  </verify>
  <done>Shared types (Task, TaskWithRelations, TaskStatus, TaskPriority, TaskType), Zod schemas (createTaskSchema, updateTaskSchema), and constants (TASK_STATUSES, TASK_PRIORITIES, RENEWAL_MILESTONES) are importable from @anchor/shared. API tsconfig has jsx: react-jsx. All new deps installed.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter database exec prisma validate` exits 0
2. `pnpm --filter database exec prisma generate` succeeds
3. `pnpm --filter shared build` succeeds (or `tsc --noEmit` in shared)
4. `@nestjs/schedule` in api deps, `@dnd-kit/core` + `@dnd-kit/sortable` + `@dnd-kit/utilities` in web deps
5. `apps/api/tsconfig.json` has `"jsx": "react-jsx"`
</verification>

<success_criteria>
- Prisma schema has Task model with all required fields, enums, indexes, and cascade relations
- User model has digestOptOut Boolean field
- ActivityEventType enum includes task_created, task_completed, task_status_changed
- Shared package exports Task types, Zod schemas, and task constants
- All new dependencies installed in correct workspace packages
- API tsconfig supports JSX for React Email templates
</success_criteria>

<output>
After completion, create `.planning/phases/03-tasks-renewals-and-dashboard/03-01-SUMMARY.md`
</output>
